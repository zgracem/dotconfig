#!/usr/bin/env ruby -w

# This Ruby script reformats its arguments into paths acceptable to an
# AppleScript which tells the Finder to put those files in the trash. Using the
# Finder's own API enables the "Put Back" feature on the trashed item(s).

require "open3"

if ARGV.empty?
  warn "Usage: trash FILE [FILE ...]"
  exit 1
end

files = begin
  ARGV.map { |f| %(the POSIX file "#{File.absolute_path(f)}") }.join(", ")
rescue Errno::ENOENT => e
  warn e.message
  exit Errno::ENOENT::Errno
end

applescript = format('tell app "Finder" to move { %<files>s } to trash', files:)
_stdin, _stdout, stderr, thread = Open3.popen3("osascript", "-e", applescript)

warn stderr.read unless thread.value.success?
exit thread.value.exitstatus
